<link rel="stylesheet" href="/static/css/Chart.css">
<div id="advance_page" class="mdui-container">
    <p></p>
    <div class="mdui-row">
        <div class="mdui-table-fluid">
            <table id="advance_table" class="mdui-table">
                <thead>
                <tr>
                    <th colspan="5">é«˜çº§è®¾ç½®</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td colspan="5" class="mdui-typo-caption-opacity">DNS æœåŠ¡å™¨</td>
                </tr>
                <tr>
                    <td>å›½å†… DNS</td>
                    <td colspan="4">
                        <div class="mdui-row">
                            <div id="local_dns" class="mdui-col-sm-3"></div>
                            <div id="modify_local_dns" class="mdui-col-sm-2">
                                <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-a100 mdui-ripple" onclick="modify_local_dns()">ä¿®æ”¹</button>
                            </div>
                            <div id="clear_local_dns" class="mdui-col-sm-2" style="display: none">
                                <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-grey-300 mdui-ripple" onclick="clear_local_dns()">æ¸…é™¤</button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>å›½å¤– DNS</td>
                    <td colspan="4">
                        <div class="mdui-row">
                            <div id="remote_dns" class="mdui-col-sm-3"></div>
                            <div id="modify_remote_dns" class="mdui-col-sm-2">
                                <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-a100 mdui-ripple" onclick="modify_remote_dns()">ä¿®æ”¹</button>
                            </div>
                            <div id="clear_remote_dns" class="mdui-col-sm-2" style="display: none">
                                <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-grey-300 mdui-ripple" onclick="clear_remote_dns()">æ¸…é™¤</button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr class="mdui-color-grey-100"><td colspan="5"></td></tr>
                <tr>
                    <td class="mdui-typo-caption-opacity">è·¯ç”±è§„åˆ™</td>
                    <td colspan="4">
                        <div class="mdui-row">
                            <div id="add_rule" class="mdui-col-sm-2">
                                <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-a100 mdui-ripple" onclick="create_rule()">æ·»åŠ </button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr class="mdui-typo-caption-opacity">
                    <td>åºå·</td>
                    <td>ç±»å‹</td>
                    <td>åŒ¹é…å€¼</td>
                    <td>ç­–ç•¥</td>
                    <td>æ“ä½œ</td>
                </tr>
                <tr id="rule_template" style="display: none">
                    <td class="rule_index"></td>
                    <td class="rule_type"></td>
                    <td class="rule_content"></td>
                    <td class="rule_policy"></td>
                    <td>
                        <div class="mdui-row">
                            <div class="mdui-chip delete_rule" title="åˆ é™¤èŠ‚ç‚¹">
                                <span class="mdui-chip-icon mdui-color-red-500"><i class="mdui-icon material-icons">delete</i></span>
                                <span class="mdui-chip-title">åˆ é™¤</span>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr class="mdui-color-grey-100"><td colspan="5"></td></tr>
                <tr>
                    <td class="mdui-typo-caption-opacity">æäº¤</td>
                    <td colspan="4">
                        <div class="mdui-row">
                            <div id="discard" class="mdui-col-sm-2" style="display: none">
                                <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-grey-300 mdui-ripple" onclick="discard_config()">æ”¾å¼ƒ</button>
                            </div>
                            <div id="apply" class="mdui-col-sm-2" style="display: none">
                                <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-accent mdui-ripple" onclick="apply_advance_config()">åº”ç”¨</button>
                            </div>
                            <div id="reset" class="mdui-col-sm-2">
                                <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-red-400 mdui-ripple" onclick="reset_advance_config()">é‡ç½®</button>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!--create rule dialog-->
<div id="rule_dialog" class="mdui-dialog">
    <div class="mdui-dialog-title">åˆ›å»ºè·¯ç”±è§„åˆ™</div>
    <div class="mdui-dialog-content">
        <div class="mdui-row">
            <div class="mdui-table-fluid">
                <table class="mdui-table">
                    <thead>
                    </thead>
                    <tbody>
                    <tr>
                        <td>ç±»å‹</td>
                        <td>åŒ¹é…å€¼</td>
                        <td>ç­–ç•¥</td>
                    </tr>
                    <tr>
                        <td>
                            <select id="select_rule_type" class="mdui-select" mdui-select="{position: 'bottom'}" onchange="select_rule_type()">
                                <option value="0" selected>IP</option>
                                <option value="1">åŸŸå</option>
                            </select>
                        </td>
                        <td>
                            <div class="mdui-textfield">
                                <input id="rule_content" class="mdui-textfield-input" type="text" value="">
                            </div>
                        </td>
                        <td>
                            <select id="select_policy_type" class="mdui-select" mdui-select="{position: 'bottom'}">
                                <option value="0" selected>ğŸŒ ç›´è¿</option>
                                <option value="1">âœˆï¸ ä»£ç†</option>
                                <option value="2">âœ‚ï¸ é˜»æ­¢</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3">
                            <div id="ip_rule_explain" style="display: none">
                                <h3>åŒ¹é…å€¼è¯´æ˜</h3>
                                <p>è®¾ç½® IP åŒ¹é…ï¼Œæœ‰ä»¥ä¸‹å‡ ç§å½¢å¼ï¼š</p>
                                <ul>
                                    <li>IP: å½¢å¦‚<code>"127.0.0.1"</code>ã€‚</li>
                                    <li><a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank">CIDR</a>: å½¢å¦‚<code>"10.0.0.0/8"</code>.</li>
                                    <li>GeoIP: å½¢å¦‚<code>"geoip:cn"</code>ï¼Œå¿…é¡»ä»¥<code>geoip:</code>ï¼ˆå°å†™ï¼‰å¼€å¤´ï¼Œåé¢è·ŸåŒå­—ç¬¦å›½å®¶ä»£ç ï¼Œæ”¯æŒå‡ ä¹æ‰€æœ‰å¯ä»¥ä¸Šç½‘çš„å›½å®¶ã€‚<ul>
                                        <li>ç‰¹æ®Šå€¼ï¼š<code>"geoip:private"</code> (V2Ray 3.5+)ï¼ŒåŒ…å«æ‰€æœ‰ç§æœ‰åœ°å€ï¼Œå¦‚<code>127.0.0.1</code>ã€‚</li>
                                    </ul>
                                    </li>
                                    <li>ä»æ–‡ä»¶ä¸­åŠ è½½ IP: å½¢å¦‚<code>"ext:file:tag"</code>ï¼Œå¿…é¡»ä»¥<code>ext:</code>ï¼ˆå°å†™ï¼‰å¼€å¤´ï¼Œåé¢è·Ÿæ–‡ä»¶åå’Œæ ‡ç­¾ï¼Œæ–‡ä»¶å­˜æ”¾åœ¨<a href="env.html#asset-location">èµ„æºç›®å½•</a>ä¸­ï¼Œæ–‡ä»¶æ ¼å¼ä¸<code>geoip.dat</code>ç›¸åŒæ ‡ç­¾å¿…é¡»åœ¨æ–‡ä»¶ä¸­å­˜åœ¨ã€‚</li>
                                </ul>
                            </div>
                            <div id="domain_rule_explain" style="display: none">
                                <h3>åŒ¹é…å€¼è¯´æ˜</h3>
                                <p>è®¾ç½®åŸŸååŒ¹é…ï¼Œæœ‰ä»¥ä¸‹å‡ ç§å½¢å¼ï¼š</p>
                                <ul>
                                    <li>çº¯å­—ç¬¦ä¸²: å½“æ­¤å­—ç¬¦ä¸²åŒ¹é…ç›®æ ‡åŸŸåä¸­ä»»æ„éƒ¨åˆ†ï¼Œè¯¥è§„åˆ™ç”Ÿæ•ˆã€‚æ¯”å¦‚"sina.com"å¯ä»¥åŒ¹é…"sina.com"ã€"sina.com.cn"å’Œ"www.sina.com"ï¼Œä½†ä¸åŒ¹é…"sina.cn"ã€‚</li>
                                    <li>æ­£åˆ™è¡¨è¾¾å¼: ç”±<code>"regexp:"</code>å¼€å§‹ï¼Œä½™ä¸‹éƒ¨åˆ†æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚å½“æ­¤æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç›®æ ‡åŸŸåæ—¶ï¼Œè¯¥è§„åˆ™ç”Ÿæ•ˆã€‚ä¾‹å¦‚"regexp:\\.goo.*\\.com$"åŒ¹é…"www.google.com"ã€"fonts.googleapis.com"ï¼Œä½†ä¸åŒ¹é…"google.com"ã€‚</li>
                                    <li>å­åŸŸå (æ¨è): ç”±<code>"domain:"</code>å¼€å§‹ï¼Œä½™ä¸‹éƒ¨åˆ†æ˜¯ä¸€ä¸ªåŸŸåã€‚å½“æ­¤åŸŸåæ˜¯ç›®æ ‡åŸŸåæˆ–å…¶å­åŸŸåæ—¶ï¼Œè¯¥è§„åˆ™ç”Ÿæ•ˆã€‚ä¾‹å¦‚"domain:v2ray.com"åŒ¹é…"www.v2ray.com"ã€"v2ray.com"ï¼Œä½†ä¸åŒ¹é…"xv2ray.com"ã€‚</li>
                                    <li>å®Œæ•´åŒ¹é…: ç”±<code>"full:"</code>å¼€å§‹ï¼Œä½™ä¸‹éƒ¨åˆ†æ˜¯ä¸€ä¸ªåŸŸåã€‚å½“æ­¤åŸŸåå®Œæ•´åŒ¹é…ç›®æ ‡åŸŸåæ—¶ï¼Œè¯¥è§„åˆ™ç”Ÿæ•ˆã€‚ä¾‹å¦‚"full:v2ray.com"åŒ¹é…"v2ray.com"ä½†ä¸åŒ¹é…"www.v2ray.com"ã€‚</li>
                                    <li>é¢„å®šä¹‰åŸŸååˆ—è¡¨ï¼šç”±<code>"geosite:"</code>å¼€å¤´ï¼Œä½™ä¸‹éƒ¨åˆ†æ˜¯ä¸€ä¸ªåç§°ï¼Œå¦‚<code>geosite:google</code>æˆ–è€…<code>geosite:cn</code>ã€‚åç§°åŠåŸŸååˆ—è¡¨å‚è€ƒ<a href="#dlc">é¢„å®šä¹‰åŸŸååˆ—è¡¨</a>ã€‚</li>
                                    <li>ä»æ–‡ä»¶ä¸­åŠ è½½åŸŸå: å½¢å¦‚<code>"ext:file:tag"</code>ï¼Œå¿…é¡»ä»¥<code>ext:</code>ï¼ˆå°å†™ï¼‰å¼€å¤´ï¼Œåé¢è·Ÿæ–‡ä»¶åå’Œæ ‡ç­¾ï¼Œæ–‡ä»¶å­˜æ”¾åœ¨<a href="env.html#asset-location">èµ„æºç›®å½•</a>ä¸­ï¼Œæ–‡ä»¶æ ¼å¼ä¸<code>geosite.dat</code>ç›¸åŒï¼Œæ ‡ç­¾å¿…é¡»åœ¨æ–‡ä»¶ä¸­å­˜åœ¨ã€‚</li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="mdui-dialog-actions">
        <button class="mdui-btn mdui-ripple mdui-text-color-grey-500" onclick="close_rule_dialog()">å–æ¶ˆ</button>
        <button class="mdui-btn mdui-ripple" onclick="add_rule()">æ·»åŠ </button>
    </div>
</div>

<script src="/static/js/Chart.js"></script>
<script type="text/javascript">
    //# sourceURL=advance.js
    $(document).ready(function () {
        refresh_remote()
    });

    var g_config_remote = null;
    var g_config_local = null;
    function refresh_remote() {
        $.get("/get_advance_config", function (data) {
            g_config_remote = data["advance_config"];
            g_config_local = JSON.parse(JSON.stringify(g_config_remote));
            refresh_local();
        });
    }

    function refresh_local() {
        var change =  JSON.stringify(g_config_remote) !== JSON.stringify(g_config_local)
        if (change) {
            $('#discard').show();
            $('#apply').show();
        }
        else {
            $('#discard').hide();
            $('#apply').hide();
        }

        dns_config = g_config_local["dns"];
        default_dns_local = dns_config["default_local"];
        default_dns_remote = dns_config["default_remote"];
        dns_local = dns_config["local"];
        dns_remote = dns_config["remote"];

        if (dns_local.length > 0) {
            $("#local_dns").html(dns_local).removeClass("mdui-text-color-black-disabled");
            $("#clear_local_dns").show();
        }
        else {
            $("#local_dns").html(default_dns_local).addClass("mdui-text-color-black-disabled");
            $("#clear_local_dns").hide();
        }

        if (dns_remote.length > 0) {
            $("#remote_dns").html(dns_remote).removeClass("mdui-text-color-black-disabled");
            $("#clear_remote_dns").show();
        }
        else {
            $("#remote_dns").html(default_dns_remote).addClass("mdui-text-color-black-disabled");
            $("#clear_remote_dns").hide();
        }

        $("tr[id^='real_rule']").remove();
        var base_policy_index = $("#rule_template").index();
        var policys = g_config_local["policys"];
        policys.forEach(function (policy) {
            var type_dic = {
                ip:'IP',
                domain:'åŸŸå'
            }
            var type = type_dic[policy['type']];
            var content = policy['content'];

            var outbound_dic = {
                direct: 'ğŸŒ',
                proxy: 'âœˆï¸',
                block: 'âœ‚ï¸'
            }
            var outbound = outbound_dic[policy['outbound']];

            var rule_row = $("#rule_template").clone();
            var index = policys.indexOf(policy);
            rule_row.attr('id', 'real_rule' + index);
            rule_row.find('.rule_index').html((index + 1).toString());
            rule_row.find('.rule_type').html(type);
            rule_row.find('.rule_content').html(content);
            rule_row.find('.rule_policy').html(outbound);

            $("#advance_table > tbody > tr").eq(base_policy_index + index).after(rule_row);
            rule_row.show();
        });

        $(".delete_rule").click(function () {
            var row = $(this).closest("tr");
            var rule_index = parseInt(row.find(".rule_index").text()) - 1;
            var policys = g_config_local["policys"];

            policys.splice(rule_index, 1);
            refresh_local();
        })
    }
    
    function modify_local_dns() {
        mdui.prompt("è¯·è¾“å…¥å›½å†… DNS åœ°å€ï¼š", function (dns) {
            dns = dns.trim();
            if (!dns.length) {
                return;
            }

            dns_config = g_config_local["dns"];
            dns_config["local"] = dns
            refresh_local();
        });
    }

    function clear_local_dns() {
        dns_config = g_config_local["dns"];
        dns_config["local"] = ""
        refresh_local();
    }
    
    function modify_remote_dns() {
        mdui.prompt("è¯·è¾“å…¥å›½å¤– DNS åœ°å€ï¼š", function (dns) {
            dns = dns.trim();
            if (!dns.length) {
                return;
            }

            dns_config = g_config_local["dns"];
            dns_config["remote"] = dns
            refresh_local();
        });
    }
    
    function clear_remote_dns() {
        dns_config = g_config_local["dns"];
        dns_config["remote"] = ""
        refresh_local();
    }

    function discard_config() {
        g_config_local = JSON.parse(JSON.stringify(g_config_remote));
        refresh_local();
    }

    function apply_advance_config() {
        pop_toast("æ­£åœ¨åº”ç”¨é«˜çº§é…ç½®...");
        $.ajax({
            url: "/set_advance_config",
            type: "POST",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(g_config_local)
        }).done(function (data) {
            if (check_result(data)) {
                update_toast("åº”ç”¨æˆåŠŸ")
            }
            else {
                update_toast("åº”ç”¨å¤±è´¥")
            }
        }).always(function () {
            close_toast();
            refresh_remote();
        });
    }

    function reset_advance_config() {
        mdui.confirm("ç¡®è®¤é‡ç½®é«˜çº§é…ç½®ä¸ºé»˜è®¤å€¼ï¼Ÿ", function () {
            pop_toast("æ­£åœ¨é‡ç½®é«˜çº§é…ç½®ä¸ºé»˜è®¤å€¼...");
            $.get('/reset_advance_config').done(function (data) {
                if (check_result(data)) {
                    update_toast("é‡ç½®æˆåŠŸ")
                }
                else {
                    update_toast("é‡ç½®å¤±è´¥")
                }
            }).always(function () {
                close_toast();
                refresh_remote();
            });
        });
    }

    var g_rule_dialog = null
    function create_rule() {
        g_rule_dialog = new mdui.Dialog("#rule_dialog", { modal:true, closeOnEsc:false});
        select_rule_type();
        g_rule_dialog.open();
        mdui.mutation();
    }

    function add_rule() {
        type_dic = {
            0: 'ip',
            1:'domain'};
        outbound_dic = {
            0: 'direct',
            1: 'proxy',
            2: 'block'
        }
        var type_index = $("#select_rule_type").prop('selectedIndex');
        type = type_dic[type_index];
        var outbound_index = $("#select_policy_type").prop('selectedIndex');
        outbound = outbound_dic[outbound_index];
        var content = $("#rule_content").val();

        $.get("/make_policy", {"type":type, "content":content, "outbound":outbound}).done(function (policy) {
            g_config_local["policys"].push(policy);
            refresh_local();
        }).always(function () {
            close_rule_dialog();
        })
    }

    function close_rule_dialog() {
        g_rule_dialog.close();
        g_rule_dialog.destroy();
        g_rule_dialog = null;
    }

    function select_rule_type() {
        var rule_type = $("#select_rule_type").prop('selectedIndex');
        if (rule_type === 0) {
            $("#ip_rule_explain").show();
            $("#domain_rule_explain").hide();
        } else if (rule_type === 1) {
            $("#ip_rule_explain").hide();
            $("#domain_rule_explain").show();
        }
        mdui.mutation();
    }

</script>